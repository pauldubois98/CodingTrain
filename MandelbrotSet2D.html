<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF8">
    <title>Mandelbrot Set</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            margin: 0;
        }

        form {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        canvas {
            border: 1px black solid;
            max-width: 100%;
            max-height: 95%;
        }

        .row {
            display: flex;
            align-items: center;
        }

        label {
            width: 5em;
            text-align: right;
            margin-right: 5px;
        }

        input[type=number] {
            width: 4em;
        }

        input[type=button] {
            margin: 0.5em;
        }
    </style>
</head>

<body>
    <h1>Mandelbrot Set</h1>
    <form>
        <div class="row">
            <label for="center_x">Center <math>
                    <mi>x</mi>
                </math></label>
            <input type="range" min="-2" max="1" step="0.01" value="-0.7" id="center_x_range"
                onchange="setCenterX(center_x_range.value)">
            <input type="number" min="-2" max="1" step="0.01" value="-0.7" id="center_x"
                onchange="setCenterX(center_x.value)">
        </div>
        <div class="row">
            <label for="center_y">Center <math>
                    <mi>y</mi>
                </math></label>
            <input type="range" min="-1" max="1" step="0.01" value="0" id="center_y_range"
                onchange="setCenterY(center_y_range.value)">
            <input type="number" min="-1" max="1" step="0.01" value="0" id="center_y"
                onchange="setCenterY(center_y.value)">
        </div>
        <div class="row">
            <label for="interval_size">Range</label>
            <input type="range" min="-7" max="2" step="0.01" value="1" id="interval_size_range"
                onchange="setIntervalSize(2**interval_size_range.value)">
            <input type="number" min="0.01" max="4" step="0.01" value="2" id="interval_size"
                onchange="setIntervalSize(interval_size.value)">
        </div>

        <div class="row">
            <label for="iterations">Iterations</label>
            <input type="range" min="1" max="1000" step="1" value="100" id="iterations_range"
                onchange="setIterations(iterations_range.value)">
            <input type="number" min="1" max="1000" step="1" value="100" id="iterations"
                onchange="setIterations(iterations.value)">
        </div>
        <div class="row">
            <label for="divergence_threshold">Divergence Threshold</label>
            <input type="range" min="1" max="50" step="1" value="20" id="divergence_threshold_range"
                onchange="setDivergenceThreshold(divergence_threshold_range.value)">
            <input type="number" min="1" max="50" step="1" value="20" id="divergence_threshold"
                onchange="setDivergenceThreshold(divergence_threshold.value)">
        </div>
        <div class="row">
            <label for="binary">Binary</label>
            <input type="checkbox" id="binary" onchange="draw(mainCanvas, mainContext)">
            <input type="button" value="Download" onclick="download()">
        </div>
    </form>
    <canvas id="mainCanvas" height="512" width="512"></canvas>
</body>

<script>
    var CENTER = { x: -0.7, y: 0 };
    var INTERVAL_SIZE = 2;
    var INTERVAL = {
        minx: CENTER.x - INTERVAL_SIZE,
        maxx: CENTER.x + INTERVAL_SIZE,
        miny: CENTER.y - INTERVAL_SIZE,
        maxy: CENTER.y + INTERVAL_SIZE,
    };
    var DIVERGENCE_THRESHOLD = 16;
    var ITERATIONS = 100
    var mainContext = null;
    function map(v, minx, maxx, miny, maxy) {
        return ((v - minx) * ((maxy - miny) / (maxx - minx))) + miny;
    }
    function init() {
        mainContext = mainCanvas.getContext("2d")
    }
    init();
    function hexToRgb(hex) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }
    function draw(canvas, ctx) {
        const currentImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const newImageData = ctx.createImageData(currentImageData);
        const data = newImageData.data;
        for (var i = 0; i < data.length; i += 4) {
            const x = (i / 4) % canvas.width;
            const y = ((i / 4) - x) / canvas.height;
            const C = {
                x: map(x, 0, canvas.width - 1, INTERVAL.minx, INTERVAL.maxx),
                y: map(y, 0, canvas.height - 1, INTERVAL.miny, INTERVAL.maxy),
            };
            var z = C;
            var iter = 0
            while (iter < ITERATIONS) {
                const a = (z.x * z.x) - (z.y * z.y);
                const b = 2 * z.x * z.y;
                z = {
                    x: a + C.x,
                    y: b + C.y,
                }
                if (Math.abs(z.x) + Math.abs(z.y) > DIVERGENCE_THRESHOLD) {
                    break;
                }
                iter++;
            }
            if (iter == ITERATIONS) {
                data[i + 0] = 0;
                data[i + 1] = 0;
                data[i + 2] = 0;
                data[i + 3] = 255;
            } else {
                if (binary.checked) {
                    data[i + 0] = 255;
                    data[i + 1] = 255;
                    data[i + 2] = 255;
                    data[i + 3] = 255;
                } else {
                    // const divergence = map(iter, 0, ITERATIONS, 0,1);
                    // const color = map(Math.sqrt(divergence), 0, 1, 0,255);
                    const color = map(iter, 0, ITERATIONS, 0, 255);
                    data[i + 0] = color;
                    data[i + 1] = color;
                    data[i + 2] = color;
                    data[i + 3] = 255;

                }
            }
        }
        ctx.putImageData(newImageData, 0, 0);
    }
    draw(mainCanvas, mainContext)

    function setCenterX(val) {
        CENTER.x = Number(val);
        INTERVAL = {
            minx: CENTER.x - INTERVAL_SIZE,
            maxx: CENTER.x + INTERVAL_SIZE,
            miny: CENTER.y - INTERVAL_SIZE,
            maxy: CENTER.y + INTERVAL_SIZE,
        };
        center_x.value = CENTER.x;
        center_x_range.value = CENTER.x;
        draw(mainCanvas, mainContext);
    }
    function setCenterY(val) {
        CENTER.y = Number(val);
        INTERVAL = {
            minx: CENTER.x - INTERVAL_SIZE,
            maxx: CENTER.x + INTERVAL_SIZE,
            miny: CENTER.y - INTERVAL_SIZE,
            maxy: CENTER.y + INTERVAL_SIZE,
        };
        center_y.value = CENTER.y;
        center_y_range.value = CENTER.y;
        draw(mainCanvas, mainContext);
    }
    function setIntervalSize(val) {
        INTERVAL_SIZE = Number(val);
        INTERVAL = {
            minx: CENTER.x - INTERVAL_SIZE,
            maxx: CENTER.x + INTERVAL_SIZE,
            miny: CENTER.y - INTERVAL_SIZE,
            maxy: CENTER.y + INTERVAL_SIZE,
        };
        interval_size.value = INTERVAL_SIZE;
        interval_size_range.value = Math.log2(INTERVAL_SIZE);
        draw(mainCanvas, mainContext);
    }
    function setIterations(val) {
        ITERATIONS = Number(val);
        iterations.value = ITERATIONS;
        iterations_range.value = ITERATIONS;
        draw(mainCanvas, mainContext);
    }
    function setDivergenceThreshold(val) {
        DIVERGENCE_THRESHOLD = Number(val);
        divergence_threshold.value = DIVERGENCE_THRESHOLD;
        divergence_threshold_range.value = DIVERGENCE_THRESHOLD;
        draw(mainCanvas, mainContext);
    }

    function download() {
        var a = document.createElement('a');
        a.download = `Mandelbrot_${CENTER.x}_${CENTER.y}_${INTERVAL_SIZE}.png`;
        a.href = document.getElementById('mainCanvas').toDataURL()
        a.click();
    }

</script>

</html>